
<div class="login-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>MQTT Dashboard</mat-card-title>
      <mat-card-subtitle>Connect to an MQTT Broker to continue</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="loginForm" (ngSubmit)="connect()">
        <!-- Broker URL -->
        <mat-form-field appearance="outline">
          <mat-label>Broker URL</mat-label>
          <input matInput formControlName="hostname" placeholder="e.g., test.mosquitto.org" required>
          @if (loginForm.get('hostname')?.hasError('required')) {
            <mat-error>Broker URL is required</mat-error>
          }
        </mat-form-field>

        <!-- Port -->
        <mat-form-field appearance="outline">
          <mat-label>Port</mat-label>
          <input matInput formControlName="port" type="number" placeholder="e.g., 8081" required>
           @if (loginForm.get('port')?.hasError('required')) {
            <mat-error>Port is required</mat-error>
          }
           @if (loginForm.get('port')?.hasError('pattern')) {
            <mat-error>Please enter a valid port number</mat-error>
          }
        </mat-form-field>

        <!-- Protocol -->
        <mat-form-field appearance="outline">
          <mat-label>Protocol</mat-label>
          <mat-select formControlName="protocol">
            <mat-option value="ws">ws</mat-option>
            <mat-option value="wss">wss</mat-option>
            <mat-option value="mqtt">mqtt</mat-option>
            <mat-option value="mqtts">mqtts</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Tenant -->
        <mat-form-field appearance="outline">
          <mat-label>Tenant</mat-label>
          <input matInput formControlName="tenant" placeholder="e.g., myTenant" required>
          @if (loginForm.get('tenant')?.hasError('required')) {
            <mat-error>Tenant is required</mat-error>
          }
        </mat-form-field>

        <!-- Username -->
        <mat-form-field appearance="outline">
          <mat-label>Username (Optional)</mat-label>
          <input matInput formControlName="username">
        </mat-form-field>

        <!-- Password -->
        <mat-form-field appearance="outline">
          <mat-label>Password (Optional)</mat-label>
          <input matInput formControlName="password" [type]="hidePassword ? 'password' : 'text'">
        </mat-form-field>

        <!-- Device Data Upload -->
        <div class="file-upload-container">
          <input type="file" #fileInput (change)="onFileSelected($event)" accept=".json" style="display: none;">
          <button mat-stroked-button type="button" color="accent" (click)="fileInput.click()">
            <mat-icon>upload_file</mat-icon> Upload Device Data (JSON)
          </button>
          @if (fileName) {
            <span class="file-name">{{ fileName }}</span>
          }
        </div>

      </form>
    </mat-card-content>

    <mat-card-actions align="end">
        <button mat-flat-button color="primary" (click)="connect()" [disabled]="!loginForm.valid || (connectionState$ | async) === 'Connecting'">
            @if ((connectionState$ | async) === 'Connecting') {
                <span>Connecting...</span>
            } @else {
                <span>Connect</span>
            }
        </button>
    </mat-card-actions>

     @if ((connectionState$ | async) === 'Connecting') {
      <div class="spinner-overlay">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
      </div>
    }
  </mat-card>
</div>
